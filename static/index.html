<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARQ Task Monitor (High Performance)</title>
    
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.15/antd.min.css" />
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.15/antd.min.js"></script>
    
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/ant-design-icons/4.7.0/index.umd.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .args-text { color: #666; font-family: Consolas, monospace; font-size: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block;}
        /* ä¿®å¤ Antd v4 è¡¨æ ¼åœ¨æŸäº›æƒ…å†µä¸‹å­—å·è¿‡å° */
        .ant-table { font-size: 13px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // === å…³é”®ä¿®æ”¹ï¼šAntd v4 çš„è§£æ„æ–¹å¼ ===
        const { Card, Table, Tag, Row, Col, Statistic, Button, Typography, Modal, Tooltip } = antd;
        const { Title } = Typography;
        
        // å›¾æ ‡åº“åœ¨ v4 CDN ä¸­é€šå¸¸æŒ‚è½½åœ¨ icons å¯¹è±¡ä¸‹
        const { ReloadOutlined, CheckCircleOutlined, SyncOutlined, CloseCircleOutlined } = icons;

        const App = () => {
            const [loading, setLoading] = React.useState(false);
            const [data, setData] = React.useState({ queued_count: 0, jobs: [] });
            const [autoRefresh, setAutoRefresh] = React.useState(true);

            const fetchData = async () => {
                setLoading(true);
                try {
                    const res = await axios.get('http://localhost:8999/api/data');
                    setData(res.data);
                } catch (err) {
                    console.error("Fetch error", err);
                    // å¦‚æœåç«¯æ²¡èµ·ï¼Œç»™ä¸ªæç¤º
                    if (data.jobs.length === 0) {
                        antd.message.error("æ— æ³•è¿æ¥ç›‘æ§åç«¯ï¼Œè¯·æ£€æŸ¥ python monitor.py æ˜¯å¦è¿è¡Œ");
                    }
                } finally {
                    setLoading(false);
                }
            };

            // é¦–æ¬¡åŠ è½½å’Œè‡ªåŠ¨åˆ·æ–°
            React.useEffect(() => {
                fetchData();
                const interval = setInterval(() => {
                    if (autoRefresh) fetchData();
                }, 3000); 
                return () => clearInterval(interval);
            }, [autoRefresh]);

            const columns = [
                {
                    title: 'Status',
                    dataIndex: 'status',
                    key: 'status',
                    width: 100,
                    render: (status) => {
                        let color = status === 'complete' ? 'success' : (status === 'queued' ? 'processing' : 'error');
                        let icon = status === 'complete' ? <CheckCircleOutlined /> : (status === 'queued' ? <SyncOutlined spin /> : <CloseCircleOutlined />);
                        let text = status === 'complete' ? 'ä»»åŠ¡å·²è°ƒåº¦' : 'ä»»åŠ¡å–æ¶ˆ/å¤±æ•ˆ'
                        return <Tag icon={icon} color={color}>{text}</Tag>;
                    }
                },
                {
                    title: 'Function',
                    dataIndex: 'function',
                    key: 'function',
                    render: (text) => <b>{text}</b>
                },
                {
                    title: 'Task Info',
                    dataIndex: 'args',
                    key: 'args',
                    render: (text) => {
                        // 1. åˆ¤æ–­æ˜¯å¦æ˜¯ç‰¹æ®Šæ ¼å¼ (å¸¦ [] çš„)
                        const isSpecial = text && text.startsWith('[');
                        
                        // 2. å®šä¹‰åŸºç¡€æ ·å¼
                        const baseStyle = {
                            display: 'block',          // å¿…é¡»æ˜¯ block æ‰èƒ½é™åˆ¶å®½åº¦
                            overflow: 'hidden',        // è¶…å‡ºéƒ¨åˆ†éšè—
                            maxHeight: '15em',          // é™åˆ¶é«˜åº¦ï¼Œè¶…è¿‡ 10 è¡Œå°±æ»šåŠ¨
                            overflowY: 'auto',         // è¶…å‡ºéƒ¨åˆ†å‚ç›´æ»šåŠ¨
                            textOverflow: 'ellipsis',  // è¶…å‡ºæ˜¾ç¤ºçœç•¥å·
                            maxWidth: '100%',          // æ’‘æ»¡å•å…ƒæ ¼
                            cursor: 'pointer',         // é¼ æ ‡å˜å°æ‰‹ï¼Œæç¤ºå¯äº¤äº’
                            fontSize: '13px',
                            fontFamily: 'Consolas, monospace' // ç”¨ç­‰å®½å­—ä½“çœ‹å‚æ•°æ›´èˆ’æœ
                        };

                        // 3. ç‰¹æ®Šæ ¼å¼åŠ é«˜äº®é¢œè‰²
                        const finalStyle = isSpecial 
                            ? { ...baseStyle, color: '#1890ff', fontWeight: '500' }
                            : { ...baseStyle, color: '#666' };

                        // 4. ä½¿ç”¨ Tooltip åŒ…è£¹ï¼Œé¼ æ ‡æ‚¬åœæ˜¾ç¤ºå…¨éƒ¨å†…å®¹
                        // overlayStyle={{ maxWidth: 600 }} è®©æµ®å±‚å®½ä¸€ç‚¹ï¼Œæ–¹ä¾¿é˜…è¯»
                        return (
                            <Tooltip title={text} placement="topLeft" overlayStyle={{ maxWidth: '600px', wordBreak: 'break-all' }}>
                                <div style={finalStyle}>
                                    {text}
                                </div>
                            </Tooltip>
                        );
                    }
                },
                {
                    title: 'Duration',
                    dataIndex: 'duration',
                    key: 'duration',
                    width: 100,
                    align: 'right'
                },
                {
                    title: 'Start Time',
                    dataIndex: 'start_time',
                    key: 'start_time',
                    width: 160,
                    align: 'center',
                    render: (text) => <span style={{fontSize:'12px', color:'#888'}}>{text}</span>
                },
                {
                    title: 'Result / Error',
                    dataIndex: 'result',
                    width:120,
                    key: 'result',
                    render: (text, record) => {
                        if (record.success) return <span style={{color: '#52c41a'}}>OK</span>;
                        return (
                            <Button 
                                type="link" 
                                danger 
                                size="small"
                                onClick={() => Modal.error({
                                    title: 'Error Details',
                                    content: <div style={{maxHeight: '400px', overflow: 'auto', whiteSpace: 'pre-wrap', fontFamily:'monospace'}}>{text}</div>,
                                    width: 600
                                })}
                            >
                                View Error
                            </Button>
                        );
                    }
                }
            ];

            return (
                <div style={{ maxWidth: 1400, margin: '0 auto' }}>
                    <div className="header">
                        <Title level={3} style={{margin:0, color: '#1890ff'}}>
                            <span style={{marginRight:10}}>ğŸš€</span> 
                            ARQ Monitor
                        </Title>
                        <div>
                            <Button 
                                type={autoRefresh ? "primary" : "default"} 
                                onClick={() => setAutoRefresh(!autoRefresh)}
                                style={{marginRight: 10}}
                            >
                                {autoRefresh ? "Auto Refresh: ON" : "Auto Refresh: OFF"}
                            </Button>
                            <Button icon={<ReloadOutlined />} onClick={fetchData} loading={loading}>
                                Refresh Now
                            </Button>
                        </div>
                    </div>

                    <Row gutter={16} style={{ marginBottom: 20 }}>
                        <Col span={6}>
                            <Card bordered={false} hoverable>
                                <Statistic 
                                    title="Queued Jobs" 
                                    value={data.queued_count} 
                                    valueStyle={{ color: data.queued_count > 0 ? '#1890ff' : '#3f8600', fontWeight: 'bold' }}
                                    prefix={<SyncOutlined spin={data.queued_count > 0} />}
                                />
                            </Card>
                        </Col>
                        <Col span={6}>
                            <Card bordered={false} hoverable>
                                <Statistic 
                                    title="Completed (Recent)" 
                                    value={data.jobs.filter(j => j.success).length} 
                                    valueStyle={{ color: '#3f8600' }}
                                    prefix={<CheckCircleOutlined />}
                                />
                            </Card>
                        </Col>
                        <Col span={6}>
                            <Card bordered={false} hoverable>
                                <Statistic 
                                    title="Failed (Recent)" 
                                    value={data.jobs.filter(j => !j.success).length} 
                                    valueStyle={{ color: '#cf1322' }}
                                    prefix={<CloseCircleOutlined />}
                                />
                            </Card>
                        </Col>
                        <Col span={6}>
                            <Card bordered={false} hoverable>
                                <Statistic 
                                    title="System Capacity" 
                                    value="20 Workers" 
                                    suffix="/ 128 Cores"
                                    valueStyle={{fontSize: '18px', color: '#666'}}
                                />
                            </Card>
                        </Col>
                    </Row>

                    <Card title="Recent Task History" bordered={false}>
                        <Table 
                            dataSource={data.jobs} 
                            columns={columns} 
                            rowKey="job_id"
                            pagination={{ pageSize: 15 }} 
                            size="middle"
                        />
                    </Card>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>